<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Gra Oszust</title>
    <style>
        /* CSS: some repeated selectors merged and optimized, order minimally changed for specificity */
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body {
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
            min-height:100vh; display:flex; justify-content:center; align-items:center;
            padding:10px; color:#fff;
        }
        .container {
            width:100%; max-width:500px; background:rgba(255,255,255,0.05);
            backdrop-filter:blur(10px);
            border-radius:20px; padding:20px;
            box-shadow:0 8px 32px rgba(0,0,0,.4);
            border:1px solid rgba(255,255,255,.1);
        }
        .screen { display:none; animation:fadeIn .3s ease; }
        .screen.active { display:block; }
        @keyframes fadeIn {
            from { opacity:0; transform:translateY(10px);}
            to   { opacity:1; transform:translateY(0);}
        }
        h1 {
            text-align:center; font-size:2em; margin-bottom:20px; white-space:nowrap;
            text-shadow:2px 2px 8px rgba(0,0,0,.5);
            background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
        }
        @media (max-width: 500px) {
            h1 { font-size:1.5em; }
        }
        .header-container {
            position:relative; display:flex; justify-content:center; align-items:center;
        }
        .instruction-btn {
            position:absolute; top:0; right:0;
            width:40px; height:40px; border-radius:50%;
            background:rgba(255,255,255,0.2); color:#fff;
            border:2px solid rgba(255,255,255,0.3);
            font-size:18px; font-weight:bold; cursor:pointer;
            display:flex; align-items:center; justify-content:center;
            transition:all .3s;
        }
        .instruction-btn:hover {
            background:rgba(255,255,255,0.3);
            transform:scale(1.1);
        }
        h2 { text-align:center;font-size:1.5em; margin-bottom:15px; }
        .input-group { margin-bottom:15px; }
        label { display:block; margin-bottom:8px; font-weight:bold; font-size:14px; }
        input[type="text"], input[type="number"], select {
            width:100%; padding:14px; border-radius:12px; font-size:16px;
            background:rgba(255,255,255,0.15); color:#fff;
            border:1px solid rgba(255,255,255,0.2); border:none;
        }
        input::placeholder { color:rgba(255,255,255,.6);}
        .input-with-btn { display:flex; gap:10px;}
        .input-with-btn input {flex:1;}
        button {
            padding:14px 24px; border-radius:12px; font-size:16px; font-weight:bold; cursor:pointer; transition:.3s all;
            background:rgba(255,255,255,0.2); color:#fff; border:1px solid rgba(255,255,255,.3); border:none;
        }
        button:hover {
            transform:translateY(-2px);
            box-shadow:0 6px 20px rgba(255,255,255,.2); background:rgba(255,255,255,0.3);
        }
        button:active { transform:translateY(0);}
        button:disabled {opacity:.3; cursor:not-allowed; transform:none;}
        .btn-primary {
            width:100%; background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
            color:#fff; padding:16px; font-size:18px; margin-top:10px; border:none;
        }
        .btn-add {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:#fff; min-width:80px;
        }
        .btn-remove {
            padding:6px 12px; font-size:13px;
            background:rgba(245,87,108,0.8); color:#fff;
        }
        .players-list {
            background:rgba(255,255,255,0.05); border-radius:12px; padding:15px; margin:15px 0;
            min-height:120px; max-height:250px; overflow-y:auto;
            border:1px solid rgba(255,255,255,0.1);
        }
        .players-list::-webkit-scrollbar { width:8px;}
        .players-list::-webkit-scrollbar-track { background:rgba(255,255,255,0.05); border-radius:10px;}
        .players-list::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.2); border-radius:10px;}
        .player-item {
            background:rgba(255,255,255,.1); padding:10px 15px; border-radius:10px; margin-bottom:8px;
            display:flex; justify-content:space-between; align-items:center;
            border:1px solid rgba(255,255,255,.15);
        }
        .empty-state {text-align:center;color:rgba(255,255,255,0.5);padding:30px;font-style:italic;}
        .player-buttons {
            display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;
            margin:20px 0; max-height:400px; overflow-y:auto; padding:5px;
        }
        .player-btn {
            padding:25px 15px; font-size:18px;
            background:linear-gradient(135deg,rgba(102,126,234,0.3) 0%,rgba(118,75,162,0.3) 100%);
            color:#fff; border-radius:15px; border:2px solid rgba(255,255,255,0.2); transition:.3s all;
        }
        .player-btn:hover {
            background:linear-gradient(135deg,rgba(102,126,234,0.5) 0%,rgba(118,75,162,0.5) 100%);
            border-color:rgba(255,255,255,.4);
        }
        .player-btn.selected {
            background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
            border-color:rgba(240,147,251,0.8);
            box-shadow:0 4px 15px rgba(240,147,251,0.4);
        }
        .role-display {
            background:rgba(255,255,255,0.05); border-radius:15px; padding:30px 20px; margin:20px 0;
            text-align:center; min-height:180px; display:flex; flex-direction:column; justify-content:center; align-items:center;
            border:2px solid rgba(255,255,255,0.15);
        }
        .role-display h2 { font-size:2.2em; margin-bottom:15px;}
        .role-display p {font-size:1.2em;margin:8px 0;line-height:1.6;}
        .role-display strong{ color:#f093fb;}
        .oszust-badge {
            background:transparent;
            padding:8px 20px; border-radius:25px; display:inline-block; margin:10px 0;
            font-size:1.3em; font-weight:bold;
            color:#f5576c;
            border:2px solid rgba(255,255,255,0.2);
        }
        .gracz-badge {
            background:transparent;
            padding:8px 20px; border-radius:25px; display:inline-block; margin:10px 0;
            font-size:1.3em; font-weight:bold;
            color:#4caf50;
            border:2px solid rgba(255,255,255,0.2);
        }
        .category-tag {
            background:rgba(255,255,255,0.15); padding:6px 15px; border-radius:20px; display:inline-block; margin:5px 0;
            font-size:.9em; border:1px solid rgba(255,255,255,.2);
        }
        .word-display {
            font-size:2em;font-weight:bold;color:#f093fb;margin:15px 0;
            text-shadow:0 2px 10px rgba(240,147,251,0.5);
        }
        .results-list {
            background:rgba(255,255,255,0.05); border-radius:12px; padding:20px; margin:20px 0;
            border:1px solid rgba(255,255,255,0.1);
        }
        .result-item {
            background:rgba(245,87,108,0.2); padding:15px; border-radius:10px; margin-bottom:10px;
            font-size:1.3em; text-align:center; border:2px solid rgba(245,87,108,0.4);
        }
        .instruction {
            text-align:center;color:rgba(255,255,255,0.7);font-size:.95em;margin:10px 0;font-style:italic;
        }
        select {
            cursor:pointer; appearance:none;
            background-image:url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat:no-repeat; background-position:right 12px center; background-size:20px; padding-right:40px;
        }
        .category-btn {
            padding:10px 8px; font-size:13px;
            background:linear-gradient(135deg,rgba(102,126,234,0.4) 0%,rgba(118,75,162,0.4) 100%);
            color:#fff; border-radius:10px; border:2px solid rgba(102,126,234,.6);
            transition:all .3s; cursor:pointer;
            word-wrap:break-word;
        }
        .category-btn:hover {
            transform:translateY(-2px);
            box-shadow:0 6px 20px rgba(102,126,234,0.3);
        }
        .category-btn.inactive {
            background:rgba(255,255,255,0.1);
            border:2px solid rgba(255,255,255,0.2);
            opacity:0.5;
        }
        #chaosOptionText.chaos-active {
            color: #ffd700;
            font-weight: bold;
        }
        #allOszusciCheckbox:checked {
            accent-color: #ffd700;
        }
        #jesterOptionText.jester-active {
            color: #9c27b0;
            font-weight: bold;
        }
        #jesterCheckbox:checked {
            accent-color: #9c27b0;
        }
        .jester-badge {
            background:transparent;
            padding:8px 20px; border-radius:25px; display:inline-block; margin:10px 0;
            font-size:1.3em; font-weight:bold;
            color:#9c27b0;
            border:2px solid rgba(255,255,255,0.2);
        }
        .instruction-content h2 {
            text-align:left; font-size:1.5em; margin:20px 0 15px 0; color:#f093fb;
        }
        .instruction-content h3 {
            text-align:left; font-size:1.2em; margin:15px 0 10px 0; color:#fff;
        }
        .instruction-content ul {
            margin:10px 0 10px 20px; line-height:1.8;
        }
        .instruction-content li {
            margin:8px 0;
        }
        .instruction-content .role-gracz {
            color:#4caf50; font-weight:bold;
        }
        .instruction-content .role-oszust {
            color:#f5576c; font-weight:bold;
        }
        .instruction-content .role-jester {
            color:#9c27b0; font-weight:bold;
        }
        .instruction-content .chaos-text {
            color:#ffd700; font-weight:bold;
        }
        .instruction-content p {
            margin:10px 0; line-height:1.6;
        }
        .instruction-content {
            overflow-y:auto;
            overflow-x:hidden;
            display:block !important;
            justify-content:flex-start !important;
            align-items:flex-start !important;
            max-height:calc(100vh - 200px);
        }
        .instruction-content::-webkit-scrollbar {
            width:10px;
        }
        .instruction-content::-webkit-scrollbar-track {
            background:rgba(255,255,255,0.05);
            border-radius:10px;
        }
        .instruction-content::-webkit-scrollbar-thumb {
            background:rgba(255,255,255,0.3);
            border-radius:10px;
        }
        .instruction-content::-webkit-scrollbar-thumb:hover {
            background:rgba(255,255,255,0.4);
        }
        .player-btn.disabled {
            opacity:0.3; cursor:not-allowed; pointer-events:none;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Ekran Menu -->
    <div id="menuScreen" class="screen active">
        <div class="header-container">
            <h1>üé≠OSZUST - GRA S≈ÅOWNA</h1>
            <button class="instruction-btn" id="instructionBtn" title="Instrukcja">?</button>
        </div>
        <div class="input-group">
            <label>Dodaj graczy (minimum 3): <span id="playerCount" style="color:#f093fb;font-weight:bold;">(0)</span></label>
            <div class="input-with-btn">
                <input type="text" id="playerInput" placeholder="Wpisz imiƒô gracza" maxlength="20" autocomplete="off">
                <button class="btn-add" id="addPlayerBtn">Dodaj</button>
            </div>
        </div>
        <div class="players-list" id="playersList">
            <div class="empty-state">Brak graczy - dodaj pierwszego!</div>
        </div>
        <div class="input-group">
            <label>Liczba oszust√≥w:</label>
            <select id="oszustySelect"></select>
        </div>
        <div class="input-group">
            <label>Wybierz kategorie: <span id="totalWordsCount" style="color:#f093fb;font-weight:bold;"></span></label>
            <div id="categoryButtons" style="display: grid; grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-top:10px;"></div>
        </div>
        <div class="input-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;">
                <input type="checkbox" id="allOszusciCheckbox" style="width:20px;height:20px;cursor:pointer;accent-color:#ffd700;">
                <span id="chaosOptionText">Opcja Chaosu</span>
            </label>
        </div>
        <div class="input-group">
            <label style="display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;">
                <input type="checkbox" id="jesterCheckbox" style="width:20px;height:20px;cursor:pointer;accent-color:#9c27b0;">
                <span id="jesterOptionText">Opcja Jester</span>
            </label>
        </div>
        <button class="btn-primary" id="startBtn" disabled>START GRY</button>
    </div>
    <!-- Ekran Gry -->
    <div id="gameScreen" class="screen">
        <h2>Kliknij swoje imiƒô, aby zobaczyƒá rolƒô</h2>
        <p class="instruction">Po zobaczeniu roli, kliknij ponownie aby ukryƒá</p>
        <div class="role-display" id="roleDisplay">
            <p>Wybierz swoje imiƒô poni≈ºej</p>
        </div>
        <div class="player-buttons" id="playerButtons"></div>
        <button class="btn-primary" id="endGameBtn">KONIEC GRY</button>
    </div>
    <!-- Ekran G≈Çosowania -->
    <div id="votingScreen" class="screen">
        <h2>üó≥Ô∏è ETAP G≈ÅOSOWANIA</h2>
        <div class="role-display" id="votingDisplay">
            <h2 id="currentVoterName"></h2>
            <p id="votingInstruction"></p>
        </div>
        <div class="player-buttons" id="votingButtons"></div>
        <div id="selectedVotes" style="margin:15px 0;min-height:50px;"></div>
        <button class="btn-primary" id="submitVoteBtn" disabled>ZATWIERD≈π G≈ÅOS</button>
        <button class="btn-primary" id="skipVotingBtn" style="margin-top:10px;background:rgba(255,255,255,0.1);">POMI≈É G≈ÅOSOWANIE</button>
    </div>
    <!-- Ekran Wynik√≥w -->
    <div id="resultScreen" class="screen">
        <h1>üéØ KONIEC GRY</h1>
        <h2>Wyniki g≈Çosowania:</h2>
        <div class="results-list" id="votingResultsList"></div>
        <button class="btn-primary" id="continueBtn" style="margin-bottom:10px;">KONTYNUUJ GRƒò</button>
        <button class="btn-primary" id="newGameBtn">NOWA GRA</button>
    </div>
    <!-- Ekran Chaos -->
    <div id="chaosScreen" class="screen">
        <h1 style="font-size:4em;margin:30px 0;">CHAOS</h1>
        <div class="role-display" style="min-height:200px;">
            <p style="font-size:1.5em;margin:20px 0;">Wszyscy gracze byli oszustami!</p>
        </div>
        <button class="btn-primary" id="continueBtnChaos" style="margin-bottom:10px;">KONTYNUUJ GRƒò</button>
        <button class="btn-primary" id="newGameBtnChaos">NOWA GRA</button>
    </div>
    <!-- Ekran Zwyciƒôstwa Jestera -->
    <div id="jesterWinScreen" class="screen">
        <div class="role-display" style="min-height:200px;border:3px solid #9c27b0;padding:30px;">
            <h1 style="font-size:3em;margin:20px 0;color:#9c27b0;">jester was wydyma≈Ç</h1>
            <p style="font-size:1.5em;margin:20px 0;">Jester zosta≈Ç wyg≈Çosowany!</p>
        </div>
        <button class="btn-primary" id="continueBtnJester" style="margin-bottom:10px;">KONTYNUUJ GRƒò</button>
        <button class="btn-primary" id="newGameBtnJester">NOWA GRA</button>
    </div>
    <!-- Ekran Instrukcji -->
    <div id="instructionScreen" class="screen">
        <h1>üìñ INSTRUKCJA</h1>
        <div class="role-display instruction-content" style="text-align:left;padding:20px;">
            <h2>Role</h2>
            <ul>
                <li><span class="role-gracz">Gracz</span> ‚Äì zna has≈Ço, podaje skojarzenia</li>
                <li><span class="role-oszust">Oszust</span> ‚Äì nie zna has≈Ça, musi je zgadnƒÖƒá lub ukryƒá siƒô</li>
                <li><span class="role-jester">Jester</span> ‚Äì zna has≈Ço, chce zostaƒá wyg≈Çosowany</li>
            </ul>

            <h2>Jak graƒá</h2>
            <p><strong>1. Losowanie</strong> ‚Äì ka≈ºdy poznaje swojƒÖ rolƒô. Gracze i Jester widzƒÖ has≈Ço, Oszust nie.</p>
            <p><strong>2. Skojarzenia</strong> ‚Äì gracze po kolei podajƒÖ skojarzenia z has≈Çem. Nie mo≈ºna u≈ºyƒá samego has≈Ça.</p>
            <p><strong>3. G≈Çosowanie</strong> ‚Äì wszyscy g≈ÇosujƒÖ na podejrzanƒÖ osobƒô.</p>

            <h2>Kto wygrywa?</h2>
            <ul>
                <li>Wyg≈Çosowano <span class="role-oszust">Oszusta</span> ‚Üí <strong>Gracze wygrywajƒÖ</strong></li>
                <li>Wyg≈Çosowano <span class="role-jester">Jestera</span> ‚Üí <strong>Jester wygrywa</strong></li>
                <li>Wyg≈Çosowano <span class="role-gracz">Gracza</span> ‚Üí <strong>Oszust wygrywa</strong></li>
            </ul>

            <h2>Opcje specjalne</h2>
            <p><span class="chaos-text">CHAOS</span> ‚Äì 25% szans ≈ºe wszyscy bƒôdƒÖ oszustami. Jester nadal mo≈ºe wygraƒá!</p>
            <p><span class="role-jester">JESTER</span> ‚Äì niezale≈ºna rola, mo≈ºe wygraƒá nawet w CHAOS.</p>
        </div>
        <button class="btn-primary" id="backFromInstructionBtn">POWR√ìT</button>
    </div>
</div>

<script>
    // === Data and State ===
    const BAZA_PYTAN = {
        "Jedzenie i picie": ["Pizza", "Bimber", "Sushi", "Hamburger", "Spaghetti", "Lody", "Pierogi", "Kebab", "Arbuz", "Truskawka", "Broku≈Ç", "Donut z cukrem", "Makaron", "Groch√≥wka", "Pomidorowa", "Coca-cola", "Ser", "Herbata", "Kawa", "Matcha", "Kakao", "Kompot", "Mas≈Ço", "Mi√≥d", "Cynamon", "Szarlotka", "Sernik", "Nachosy", "Popcorn", "Szpinak", "Rodzynki", "Orzechy laskowe", "Og√≥rkowa", "Ros√≥≈Ç", "Whiskey", "W√≥dka", "Piwo", "Piwo bezalkoholowe", "Woda", "Cebularz", "Brownie", "Croissant", "Bu≈Çka z mas≈Çem", "≈ªurek", "Bigos", "Schabowy", "Kotlet mielony", "Gofry", "Nale≈õniki", "PƒÖczek"],
        "Filmy": ["Titanic", "Avatar", "Gladiator", "Matrix", "Shrek", "Joker", "Interstellar", "Furioza", "Pulp Fiction", "Ojciec chrzestny", "Incepcja", "W≈Çadca Pier≈õcieni", "Harry Potter", "Piraci z Karaib√≥w", "Gwiezdne wojny", "Kr√≥l Lew", "Frozen", "Avengers", "Spider-Man", "Batman", "Superman", "Iron Man", "Toy Story", "Jurassic Park", "Terminator", "Forrest Gump", "Zielona mila", "Siedem", "Fighter", "Whiplash", "Gladiator", "Jak wytresowaƒá smoka", "Nemo", "Madagaskar", "Kung Fu Panda", "Shreka", "Across the Spider-Verse", "Deadpool", "Wolverine", "Thor", "Czarny ≈Åabƒôd≈∫", "Incepcja", "Django", "Venom", "D≈∫wiƒôk ciszy", "La La Land", "1917", "Dunkirk", "Tenet", "Oppenheimer"],
        "Przedmioty": ["T≈Çok", "Krzes≈Ço", "St√≥≈Ç", "Lampa", "Telefon", "Komputer", "Klawiatura", "Myszka", "Monitor", "Zeszyt", "D≈Çugopis", "Poduszka", "Koc", "≈Å√≥≈ºko", "Szafa", "Lustro", "Zegar", "Dywan", "Zas≈Çona", "Doniczka", "Kwiat", "Pilot", "Telewizor", "S≈Çuchawki", "G≈Ço≈õnik", "Mikrofon", "≈Åadowarka", "Kabel", "Pendrive", "Powerbank", "Klucze", "Portfel", "Dokumenty", "Karta", "Okulary", "Etui", "Parasol", "Torba", "Walizka", "Czapka", "Kurtka", "Rƒôkawiczki", "Skarpetki", "Buty", "Pasek", "Szalik", "Szczoteczka do zƒôb√≥w", "Grzebie≈Ñ", "Rƒôcznik", "Myd≈Ço"],
        "Zwierzƒôta": ["Papuga", "Jednoro≈ºec", "Kot", "Pies", "S≈Ço≈Ñ", "Delfin", "Orze≈Ç", "Lew", "Pingwin", "Koala", "≈ölimak", "≈ªyrafa", "Zebra", "Hipopotam", "Nosoro≈ºec", "Kangur", "Panda", "Nied≈∫wied≈∫", "Wilk", "Lis", "Kr√≥lik", "Chomik", "≈ª√≥≈Çw", "Krokodyl", "Rekin"],
        "Zawody": ["Lekarz", "Nauczyciel", "Stra≈ºak", "Pilot", "Kucharz", "Prawnik", "Programista", "Aktor", "Pielƒôgniarka", "Policjant", "Mechanik", "Elektryk", "Hydraulik", "≈ömieciarz", "Kierowca autobusu", "Architekt", "In≈ºynier", "Dziennikarz", "Fotograf", "Fryzjer", "Sprzedawca", "Kelner", "Bibliotekarz", "Weterynarz", "Dentysta"],
        "Sport": ["Pi≈Çka no≈ºna", "Koszyk√≥wka", "Siatk√≥wka", "Tenis", "Tenis sto≈Çowy", "Pi≈Çka rƒôczna", "P≈Çywanie", "Skoki do wody", "Nurkowanie", "≈Åucznictwo", "≈Åy≈ºwiarstwo figurowe", "Snowboard", "Skoki narciarskie", "Lekkoatletyka", "Bieganie", "Sprint", "Skok wzwy≈º", "Rzut m≈Çotem", "Rzut dyskiem", "Trampolina", "Akrobatyka", "Judo", "Karate", "Boks", "Kickboxing", "Kolarstwo torowe", "Kolarstwo szosowe", "Kolarstwo g√≥rskie", "Rzut kulƒÖ", "Siatk√≥wka pla≈ºowa", "Mini golf", "Skateboarding", "Skoki spadochronowe", "Kulturystyka", "Si≈Çownia", "Przysiady", "PodciƒÖganie", "Szachy", "Warcaby", "Wspinaczka"],
        "Supermoce": ["Latanie", "Niewidzialno≈õƒá", "Super si≈Ça", "Super szybko≈õƒá", "Teleportacja", "Czytanie w my≈õlach", "Kontrola czasu", "Strzelanie piorunami", "Strzelanie ogniem", "Kontrola lodu", "Zamra≈ºanie", "Regeneracja", "Nie≈õmiertelno≈õƒá", "Kontrola wody", "Kontrola ziemi", "Kontrola wiatru", "Lasery z oczu", "Telekineza", "Zmiana kszta≈Çtu", "Super inteligencja", "Kontrola umys≈Çu", "Tworzenie iluzji", "Przechodzenie przez ≈õciany", "Super s≈Çuch", "Super wzrok"],
        "Kraje": ["Polska", "Niemcy", "Francja", "W≈Çochy", "Hiszpania", "Wielka Brytania", "USA", "Kanada", "Meksyk", "Brazylia", "Argentyna", "Japonia", "Chiny", "Indie", "Rosja", "Australia", "Egipt", "RPA", "Grecja", "Turcja", "Holandia", "Belgia", "Szwecja", "Norwegia", "Portugalia"],
        "Muzyka": ["The Beatles", "Queen", "Michael Jackson", "Madonna", "Elvis Presley", "Bob Marley", "Nirvana", "Metallica", "AC/DC", "Pink Floyd", "Led Zeppelin", "U2", "Coldplay", "Imagine Dragons", "Ed Sheeran", "Taylor Swift", "Beyonc√©", "Rihanna", "Drake", "Eminem", "Dawid Podsiad≈Ço", "Sanah", "Taco Hemingway", "Doda", "Czes≈Çaw Niemen"],
        "Pojazdy": ["Samoch√≥d", "Rower", "Motor", "Autobus", "Tramwaj", "PociƒÖg", "Metro", "Samolot", "Helikopter", "Statek", "Jacht", "≈Å√≥d≈∫", "Kajak", "≈ªagl√≥wka", "Poduszkowiec", "Ciƒô≈ºar√≥wka", "Traktor", "Kombajn", "Czo≈Çg", "Rakieta", "Prom kosmiczny", "Balon na ogrzane powietrze", "Skuter", "Hulajnoga elektryczna", "Deskorolka"],
        "Miejsca": ["Zamek", "Szko≈Ça", "Szpital", "Ko≈õci√≥≈Ç", "Restauracja", "Kino", "Teatr", "Muzeum", "Biblioteka", "Basen", "Stadion", "Park", "Zoo", "Aquapark", "Plac zabaw", "Sklep", "Supermarket", "Apteka", "Bank", "Poczta", "Dworzec kolejowy", "Lotnisko", "Stacja benzynowa", "Hotel", "Hostel", "Camping", "Pla≈ºa", "Las", "G√≥ry", "Jaskinia", "Most", "Tunel", "Wie≈ºa", "Ratusz", "UrzƒÖd", "Komisariat", "Stra≈º po≈ºarna", "Cmentarz", "Port", "Przysta≈Ñ", "Kawiarnia", "Pub", "Klub nocny", "Si≈Çownia", "Warszawa", "Lodowisko", "Krƒôgielnia", "Escape room", "Galeria handlowa", "Parking"]
    };

    let gracze = [], liczbaOszustow = 1, graczeDane = {}, aktualnieWidoczny = null;
    let wybraneKategorie = new Set(Object.keys(BAZA_PYTAN));
    let wszyscyOszusciEnabled = false;
    let jesterEnabled = false; // czy opcja Jester jest w≈ÇƒÖczona
    let czyChaos = false; // czy wszyscy sƒÖ oszustami (opcja chaos)
    let glosy = {}; // {gracz: [lista zag≈Çosowanych]}
    let aktualnyGlosujacy = 0; // indeks w tablicy gracze
    let wybraneDoGlosowania = []; // tymczasowa lista wybranych do g≈Çosowania

    // === DOM Cache ===
    const $ = id => document.getElementById(id);
    const playerInput = $('playerInput'),
          addPlayerBtn = $('addPlayerBtn'),
          playersList = $('playersList'),
          playerCount = $('playerCount'),
          oszustySelect = $('oszustySelect'),
          categoryButtons = $('categoryButtons'),
          totalWordsCount = $('totalWordsCount'),
          startBtn = $('startBtn'),
          allOszusciCheckbox = $('allOszusciCheckbox'),
          jesterCheckbox = $('jesterCheckbox'),
          roleDisplay = $('roleDisplay'),
          playerButtons = $('playerButtons'),
          endGameBtn = $('endGameBtn'),
          votingDisplay = $('votingDisplay'),
          currentVoterName = $('currentVoterName'),
          votingInstruction = $('votingInstruction'),
          votingButtons = $('votingButtons'),
          selectedVotes = $('selectedVotes'),
          submitVoteBtn = $('submitVoteBtn'),
          skipVotingBtn = $('skipVotingBtn'),
          votingResultsList = $('votingResultsList'),
          continueBtn = $('continueBtn'),
          newGameBtn = $('newGameBtn'),
          continueBtnChaos = $('continueBtnChaos'),
          newGameBtnChaos = $('newGameBtnChaos'),
          continueBtnJester = $('continueBtnJester'),
          newGameBtnJester = $('newGameBtnJester'),
          instructionBtn = $('instructionBtn'),
          backFromInstructionBtn = $('backFromInstructionBtn');

    // === Helper Functions ===
    // Fisher-Yates shuffle
    const shuffleArray = arr => {
        const shuffled = [...arr];
        for(let i = shuffled.length - 1; i > 0; i--){
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    };

    // Get random element from array
    const randomElement = arr => arr[Math.floor(Math.random() * arr.length)];

    // Updates "Liczba oszust√≥w" depending on # of players
    const updateOszustyOptions = () => {
        const maxOszustow = gracze.length <= 4 ? 1 : gracze.length <= 7 ? 2 : 3;
        if (liczbaOszustow > maxOszustow) liczbaOszustow = 1;
        
        oszustySelect.innerHTML = '';
        for (let i = 1; i <= maxOszustow; i++) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = i;
            if (i === liczbaOszustow || (liczbaOszustow > maxOszustow && i === 1)) {
                opt.selected = true;
            }
            oszustySelect.appendChild(opt);
        }
    };

    // Update player count
    const updatePlayerCount = () => {
        if (playerCount) playerCount.textContent = `(${gracze.length})`;
    };

    // Player list rendering
    const updatePlayersList = () => {
        updatePlayerCount();
        if (!gracze.length) {
            playersList.innerHTML = '<div class="empty-state">Brak graczy - dodaj pierwszego!</div>';
            return;
        }
        const escapeAttr = s => String(s).replace(/'/g, '&#39;');
        playersList.innerHTML = gracze.map(gracz =>
            `<div class="player-item">
                <span>${gracz}</span>
                <button class="btn-remove" data-player="${escapeAttr(gracz)}">Usu≈Ñ</button>
            </div>`
        ).join('');
    };

    // Start button enable/disable
    const updateStartButton = () => {
        startBtn.disabled = gracze.length < 3 || wybraneKategorie.size === 0;
    };

    const updateOszusty = () => {
        liczbaOszustow = parseInt(oszustySelect.value, 10) || 1;
    };

    // Update total words count from selected categories
    const updateTotalWordsCount = () => {
        if (!totalWordsCount) return;
        const total = [...wybraneKategorie].reduce((sum, k) => sum + (BAZA_PYTAN[k]?.length || 0), 0);
        const text = total === 0 ? '(brak hase≈Ç)' : 
                     total === 1 ? `(${total} has≈Ço)` : 
                     total < 5 ? `(${total} has≈Ça)` : 
                     `(${total} hase≈Ç)`;
        totalWordsCount.textContent = text;
    };

    const updateCategoryButtons = () => {
        categoryButtons.innerHTML = Object.keys(BAZA_PYTAN).map(kategoria => {
            const isSelected = wybraneKategorie.has(kategoria);
            return `<button class="category-btn${isSelected ? '' : ' inactive'}" data-category="${kategoria}">
                ${isSelected ? '‚úì ' : ''}${kategoria}
            </button>`;
        }).join('');
        updateTotalWordsCount();
    };

    // === Event Registration ===
    // Add Player event
    addPlayerBtn.onclick = function() {
        const imie = playerInput.value.trim();
        if (imie && !gracze.includes(imie)) {
            gracze.push(imie);
            playerInput.value = '';
            updatePlayersList();
            updateOszustyOptions();
            updateStartButton();
        }
    };
    playerInput.addEventListener('keypress', function(e) {
        if(e.key==='Enter') addPlayerBtn.click();
    });
    playersList.addEventListener('click', function(e) {
        const btn = e.target.closest('.btn-remove');
        if(btn) {
            const imie = btn.getAttribute('data-player');
            gracze = gracze.filter(g => g !== imie);
            updatePlayersList();
            updateOszustyOptions();
            updateStartButton();
        }
    });
    oszustySelect.onchange = updateOszusty;
    // Category toggle
    categoryButtons.addEventListener('click', function(e){
        const btn = e.target.closest('.category-btn');
        if(!btn) return;
        const kategoria = btn.getAttribute('data-category');
        if(wybraneKategorie.has(kategoria)) {
            wybraneKategorie.delete(kategoria);
        } else {
            wybraneKategorie.add(kategoria);
        }
        updateCategoryButtons();
        updateStartButton();
    });
    allOszusciCheckbox.onchange = () => {
        wszyscyOszusciEnabled = allOszusciCheckbox.checked;
        $('chaosOptionText')?.classList.toggle('chaos-active', wszyscyOszusciEnabled);
    };
    jesterCheckbox.onchange = () => {
        jesterEnabled = jesterCheckbox.checked;
        $('jesterOptionText')?.classList.toggle('jester-active', jesterEnabled);
    };

    // Start Game
    startBtn.onclick = function() {
        if(gracze.length < 3 || !wybraneKategorie.size) return;
        let wszyscyOszusci = false;
        if (wszyscyOszusciEnabled && Math.random() < 0.25) wszyscyOszusci = true;
        czyChaos = wszyscyOszusci;
        const kategoria = randomElement([...wybraneKategorie]);
        const haslo = randomElement(BAZA_PYTAN[kategoria]);

        let oszusci;
        let jester = null; // maksymalnie 1 gracz z rolƒÖ Jester
        
        if (jesterEnabled && gracze.length > 0) {
            // Najpierw losuj Jestera (niezale≈ºnie od CHAOS)
            jester = randomElement(gracze);
        }
        
        if (wszyscyOszusci) {
            // W chaosie wszyscy sƒÖ oszustami (opr√≥cz Jestera, kt√≥ry jest niezale≈ºnƒÖ rolƒÖ)
            oszusci = gracze.filter(g => g !== jester);
        } else {
            // Normalny tryb - losuj oszust√≥w (ale nie Jestera)
            const kandydaciNaOszustow = gracze.filter(g => g !== jester);
            oszusci = shuffleArray(kandydaciNaOszustow).slice(0, liczbaOszustow);
        }
        
        graczeDane = {};
        gracze.forEach(g=>{
            if (g === jester) {
                // Jester jest niezale≈ºnƒÖ rolƒÖ - nie jest oszustem, nawet w CHAOS
                graczeDane[g] = {
                    rola: 'JESTER',
                    haslo: haslo,
                    kategoria,
                    jestOszustem: false, // Jester NIE jest oszustem, nawet w CHAOS
                    jestJester: true
                };
            } else {
                const jestOszustem = oszusci.includes(g);
                graczeDane[g] = {
                    rola: jestOszustem ? 'OSZUST':'GRACZ',
                    haslo: jestOszustem ? null : haslo,
                    kategoria,
                    jestOszustem: jestOszustem,
                    jestJester: false
                };
            }
        });
        // Render player buttons
        playerButtons.innerHTML = gracze.map(gracz =>
            `<button class="player-btn" data-player="${gracz}">${gracz}</button>`
        ).join('');
        aktualnieWidoczny = null;
        roleDisplay.innerHTML = '<p>Wybierz swoje imiƒô poni≈ºej</p>';
        endGameBtn.textContent = 'KONIEC GRY';
        updatePlayerButtonsState();
        showScreen('gameScreen');
    };

    // Check if all buttons are removed and update end game button
    const checkAllButtonsRemoved = () => {
        endGameBtn.textContent = playerButtons.querySelectorAll('.player-btn').length === 0 
            ? 'ETAP G≈ÅOSOWANIA' 
            : 'KONIEC GRY';
    };

    // Update button states based on visible role
    const updatePlayerButtonsState = () => {
        playerButtons.querySelectorAll('.player-btn').forEach(btn => {
            const btnGracz = btn.getAttribute('data-player');
            btn.classList.toggle('disabled', aktualnieWidoczny && aktualnieWidoczny !== btnGracz);
        });
    };

    // Show/Hide role
    playerButtons.addEventListener('click', function(e){
        const btn = e.target.closest('.player-btn');
        if(!btn || btn.classList.contains('disabled')) return;
        const gracz = btn.getAttribute('data-player');
        if(aktualnieWidoczny === gracz) {
            roleDisplay.innerHTML = '<p>Wybierz swoje imiƒô poni≈ºej</p>';
            aktualnieWidoczny = null;
            btn.remove(); // remove clicked button after role hidden
            checkAllButtonsRemoved();
            updatePlayerButtonsState();
        } else {
            const dane = graczeDane[gracz];
            aktualnieWidoczny = gracz;
            // Use template for minimal DOM construction
            if(dane.jestJester) {
                roleDisplay.innerHTML = `
                    <h2>${gracz}</h2>
                    <div class="jester-badge">JESTER</div>
                    <div class="word-display">${dane.haslo}</div>
                    <p><span class="category-tag">Kategoria: ${dane.kategoria}</span></p>
                    <p style="margin-top:20px;color:rgba(255,255,255,.7);">Twoim zadaniem jest zostaƒá wyg≈Çosowanym!</p>
                `;
            } else if(dane.jestOszustem) {
                roleDisplay.innerHTML = `
                    <h2>${gracz}</h2>
                    <div class="oszust-badge">OSZUST</div>
                    <p><span class="category-tag">Kategoria: ${dane.kategoria}</span></p>
                    <p style="margin-top:20px;color:rgba(255,255,255,.7);">Nie znasz has≈Ça - musisz je odgadnƒÖƒá!</p>
                `;
            } else {
                roleDisplay.innerHTML = `
                    <h2>${gracz}</h2>
                    <div class="gracz-badge">GRACZ</div>
                    <div class="word-display">${dane.haslo}</div>
                    <p><span class="category-tag">Kategoria: ${dane.kategoria}</span></p>
                `;
            }
            updatePlayerButtonsState();
        }
    });

    // Start voting or end game
    endGameBtn.onclick = function() {
        const remainingButtons = playerButtons.querySelectorAll('.player-btn');
        if (remainingButtons.length === 0) {
            // Start voting
            startVoting();
        } else {
            // End game without voting
            showResults();
        }
    };

    // Initialize voting
    const startVoting = () => {
        glosy = {};
        aktualnyGlosujacy = 0;
        wybraneDoGlosowania = [];
        showNextVoter();
    };

    // Show next voter
    const showNextVoter = () => {
        if (aktualnyGlosujacy >= gracze.length) {
            // All votes collected, show results
            showVotingResults();
            return;
        }

        const gracz = gracze[aktualnyGlosujacy];
        currentVoterName.textContent = gracz;
        votingInstruction.textContent = `Wybierz ${liczbaOszustow} ${liczbaOszustow === 1 ? 'osobƒô' : 'osoby'}, kt√≥rƒÖ uwa≈ºasz za oszusta:`;
        
        // Create voting buttons (all players except current voter)
        const pozostaliGracze = gracze.filter(g => g !== gracz);
        votingButtons.innerHTML = pozostaliGracze.map(g =>
            `<button class="player-btn vote-btn" data-vote="${g}">${g}</button>`
        ).join('');

        wybraneDoGlosowania = [];
        selectedVotes.innerHTML = '';
        updateSubmitButton();
        showScreen('votingScreen');
    }

    // Handle vote button clicks
    votingButtons.addEventListener('click', function(e) {
        const btn = e.target.closest('.vote-btn');
        if (!btn) return;
        
        const votedPlayer = btn.getAttribute('data-vote');
        const index = wybraneDoGlosowania.indexOf(votedPlayer);
        
        if (index > -1) {
            // Deselect
            wybraneDoGlosowania.splice(index, 1);
            btn.classList.remove('selected');
        } else {
            // Select (if not at max)
            if (wybraneDoGlosowania.length < liczbaOszustow) {
                wybraneDoGlosowania.push(votedPlayer);
                btn.classList.add('selected');
            }
        }
        
        updateSelectedVotesDisplay();
        updateSubmitButton();
    });

    // Update selected votes display
    const updateSelectedVotesDisplay = () => {
        if (wybraneDoGlosowania.length === 0) {
            selectedVotes.innerHTML = '';
            return;
        }
        selectedVotes.innerHTML = `
            <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);">
                <p style="margin-bottom:10px;font-weight:bold;">Wybrane osoby:</p>
                <div style="display:flex;flex-wrap:wrap;gap:8px;">
                    ${wybraneDoGlosowania.map(g => 
                        `<span class="category-tag" style="background:rgba(240,147,251,0.3);">${g}</span>`
                    ).join('')}
                </div>
            </div>
        `;
    };

    // Update submit button state
    const updateSubmitButton = () => {
        submitVoteBtn.disabled = wybraneDoGlosowania.length !== liczbaOszustow;
    };

    // Submit vote
    submitVoteBtn.onclick = function() {
        if (wybraneDoGlosowania.length !== liczbaOszustow) return;
        
        const gracz = gracze[aktualnyGlosujacy];
        glosy[gracz] = wybraneDoGlosowania.slice();
        aktualnyGlosujacy++;
        showNextVoter();
    };

    // Skip voting
    skipVotingBtn.onclick = function() {
        showResults();
    };

    // Count votes (shared function)
    const countVotes = () => {
        const voteCounts = {};
        gracze.forEach(g => voteCounts[g] = 0);
        Object.values(glosy).forEach(votes => {
            votes.forEach(voted => voteCounts[voted]++);
        });
        return voteCounts;
    };

    // Check if Jester won - Jester wygrywa je≈õli zosta≈Ç wyg≈Çosowany (nawet w CHAOS)
    const checkJesterWin = (voteCounts) => {
        const sortedVotes = gracze.map(g => ({ 
            name: g, 
            votes: voteCounts[g] || 0,
            jestJester: graczeDane[g]?.jestJester
        })).sort((a, b) => b.votes - a.votes);
        
        // Jester wygrywa je≈õli jest w≈õr√≥d top wyg≈Çosowanych (liczbaOszustow najwy≈ºej g≈Çosowanych)
        const topPlayers = sortedVotes.slice(0, liczbaOszustow);
        return topPlayers.some(p => p.jestJester);
    };

    // Render voting results (shared function)
    const renderVotingResults = (voteCounts) => {
        const sortedVotes = gracze.map(g => ({ 
            name: g, 
            votes: voteCounts[g] || 0,
            jestOszustem: graczeDane[g]?.jestOszustem,
            jestJester: graczeDane[g]?.jestJester
        })).sort((a, b) => b.votes - a.votes);

        const topCount = liczbaOszustow;
        let html = '';
        
        // Dodaj informacjƒô o chaosie je≈õli by≈Ç
        if (czyChaos) {
            const jestJester = gracze.some(g => graczeDane[g]?.jestJester);
            html += `<div class="result-item" style="background:rgba(255,215,0,0.3);border-color:rgba(255,215,0,0.6);margin-bottom:15px;">
                <strong style="color:#ffd700;font-size:1.2em;">CHAOS!</strong><br>
                Wszyscy gracze byli oszustami!${jestJester ? ' (Jester jest niezale≈ºnƒÖ rolƒÖ)' : ''}
            </div>`;
        }
        
        html += sortedVotes.map((item, index) => {
            let roleBadge;
            if (item.jestJester) {
                roleBadge = '<span style="color:#9c27b0;font-weight:bold;">JESTER</span>';
            } else if (item.jestOszustem) {
                roleBadge = '<span style="color:#f5576c;font-weight:bold;">OSZUST</span>';
            } else {
                roleBadge = '<span style="color:#4caf50;font-weight:bold;">GRACZ</span>';
            }
            
            const isCorrect = index < topCount && item.jestOszustem;
            const bgColor = isCorrect 
                ? 'background:rgba(76,175,80,0.3);border-color:rgba(76,175,80,0.6);' 
                : 'background:rgba(102,126,234,0.2);border-color:rgba(102,126,234,0.4);';
            
            return `<div class="result-item" style="${bgColor}">
                ${item.name}: ${item.votes} ${item.votes === 1 ? 'g≈Ços' : 'g≈Ços√≥w'} - ${roleBadge}
            </div>`;
        }).join('');
        
        return html;
    };

    // Show voting results
    const showVotingResults = () => {
        const voteCounts = countVotes();
        if (checkJesterWin(voteCounts)) {
            showScreen('jesterWinScreen');
            return;
        }
        votingResultsList.innerHTML = renderVotingResults(voteCounts);
        showScreen('resultScreen');
    };

    // Show results without voting or with partial voting
    const showResults = () => {
        const hasVotes = Object.keys(glosy).length > 0;
        if (hasVotes) {
            const voteCounts = countVotes();
            if (checkJesterWin(voteCounts)) {
                showScreen('jesterWinScreen');
                return;
            }
            votingResultsList.innerHTML = renderVotingResults(voteCounts);
        } else {
            votingResultsList.innerHTML = '<div class="result-item" style="background:rgba(255,255,255,0.1);">G≈Çosowanie pominiƒôte</div>';
        }
        showScreen('resultScreen');
    };

    // Reset game state (shared function)
    const resetGameState = () => {
        graczeDane = {}; 
        aktualnieWidoczny = null;
        glosy = {};
        aktualnyGlosujacy = 0;
        wybraneDoGlosowania = [];
        czyChaos = false;
        endGameBtn.textContent = 'KONIEC GRY';
    };

    // Continue Game (shared handler)
    const continueGame = () => {
        resetGameState();
        showScreen('menuScreen');
    };
    continueBtn.onclick = continueGame;
    continueBtnChaos.onclick = continueGame;
    continueBtnJester.onclick = continueGame;

    // Reset all game data (shared function)
    const resetAllGameData = () => {
        gracze = [];
        liczbaOszustow = 1;
        graczeDane = {};
        aktualnieWidoczny = null;
        wybraneKategorie = new Set(Object.keys(BAZA_PYTAN));
        wszyscyOszusciEnabled = false;
        jesterEnabled = false;
        czyChaos = false;
        glosy = {};
        aktualnyGlosujacy = 0;
        wybraneDoGlosowania = [];
        playerInput.value = '';
        allOszusciCheckbox.checked = false;
        jesterCheckbox.checked = false;
        endGameBtn.textContent = 'KONIEC GRY';
        updatePlayersList();
        updateOszustyOptions();
        updateCategoryButtons();
        updateStartButton();
        $('chaosOptionText')?.classList.remove('chaos-active');
        $('jesterOptionText')?.classList.remove('jester-active');
    };

    // New Game (shared handler)
    const newGame = () => {
        resetAllGameData();
        showScreen('menuScreen');
    };
    newGameBtn.onclick = newGame;
    newGameBtnChaos.onclick = newGame;
    newGameBtnJester.onclick = newGame;

    // === Show/Hide screens ===
    const showScreen = screenId => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        $(screenId)?.classList.add('active');
    };

    // Instruction button handler
    instructionBtn.onclick = function() {
        showScreen('instructionScreen');
    };

    // Back from instruction button handler
    backFromInstructionBtn.onclick = function() {
        showScreen('menuScreen');
    };

    // === Initial Rendering ===
    updateOszustyOptions();
    updatePlayersList();
    updateCategoryButtons();
    updateStartButton();
    // Check initial state of chaos and jester checkboxes
    const chaosText = $('chaosOptionText');
    const jesterText = $('jesterOptionText');
    if (chaosText) {
        chaosText.classList.toggle('chaos-active', allOszusciCheckbox.checked);
    }
    if (jesterText) {
        jesterText.classList.toggle('jester-active', jesterCheckbox.checked);
    }
</script>
</body>
</html>
